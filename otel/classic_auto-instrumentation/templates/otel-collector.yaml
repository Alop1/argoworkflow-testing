apiVersion: v1
kind: ServiceAccount
metadata:
  name: otel-collector
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: otel-collector
rules:
  - apiGroups: [""]
    resources: ["pods", "nodes"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["apps"]
    resources: ["replicasets"]
    verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: otel-collector
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: otel-collector
subjects:
  - kind: ServiceAccount
    name: otel-collector
    namespace: {{ .Release.Namespace }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config
data:
  config.yaml: |
    receivers:
      otlp:
        protocols:
          grpc:
          http:

      filelog:
        include:
          - /var/log/containers/*_{{ .Release.Namespace }}_{{ .Values.serviceA.name }}-*.log
          - /var/log/containers/*_{{ .Release.Namespace }}_{{ .Values.serviceB.name }}-*.log
          - /var/log/containers/*_{{ .Release.Namespace }}_{{ .Values.serviceC.name }}-*.log
        start_at: beginning
        include_file_path: true
        include_file_name: false
        operators:
          # 0) CRI JSON -> rozpakuj do pól (log, stream, time)
          - type: json_parser
            parse_from: body
            on_error: drop

          # 1) pracujemy dalej na samym tekście logu
          - type: move
            from: attributes.log
            to: body
            on_error: send_quiet

          # 2) wyciągamy pod / namespace / container z nazwy pliku
          # /var/log/containers/<pod>_<ns>_<container>-<id>.log
          - type: regex_parser
            parse_from: attributes["log.file.path"]
            regex: ".*/(?P<pod_name>[^_]+)_(?P<namespace_name>[^_]+)_(?P<container_name>[^-]+-[^-]+)-.*\\.log"
            on_error: send_quiet

          # service_name + namespace jako zwykłe atrybuty
          - type: move
            from: attributes.container_name
            to: attributes.service_name
            on_error: send_quiet

          - type: move
            from: attributes.namespace_name
            to: attributes.service_namespace
            on_error: send_quiet

          # 3) trace_id / span_id / trace_sampled z body
          - type: regex_parser
            parse_from: body
            regex: "trace_id=(?P<trace_id>[^ ]+)"
            on_error: send_quiet

          - type: regex_parser
            parse_from: body
            regex: "span_id=(?P<span_id>[^ ]+)"
            on_error: send_quiet

          - type: regex_parser
            parse_from: body
            regex: "trace_sampled=(?P<trace_sampled>[^\\] ]+)"
            on_error: send_quiet

          # 4) wyciągamy samą wiadomość logu (po ' - ')
          # np.
          # 2025-12-09 ... [trace...] - Received request ...
          # 2025-12-09 ... [trace...] - 127.0.0.1 - - [..] "GET /..." 200 -
          - type: regex_parser
            parse_from: body
            regex: "^.*? - (?P<log_message>.*)$"
            on_error: send_quiet

          - type: move
            from: attributes.log_message
            to: body
            on_error: send_quiet

    # procesory – dodatkowe wzbogacenie logów
    processors:
      # k8sattributes:
      #   auth_type: serviceAccount
      #   extract:
      #     metadata:
      #       - k8s.pod.name
      #       - k8s.namespace.name
      #       - k8s.node.name
      #       - k8s.pod.uid
      #       - k8s.deployment.name
      #       - k8s.container.name

      transform/enrich-logs:
        log_statements:
          - context: log
            statements:
              # powiązanie z k8s
              - set(attributes["k8s.pod.name"], attributes["pod_name"]) where attributes["pod_name"] != nil
              - set(attributes["k8s.container.name"], attributes["service_name"]) where attributes["service_name"] != nil
              - set(attributes["k8s.namespace.name"], attributes["service_namespace"]) where attributes["service_namespace"] != nil

              # trace + span jako ładne klucze
              - set(attributes["trace.id"], attributes["trace_id"]) where attributes["trace_id"] != nil
              - set(attributes["span.id"], attributes["span_id"]) where attributes["span_id"] != nil

              # porządkowanie pól logu
              - set(attributes["log.file"], attributes["log.file.path"]) where attributes["log.file.path"] != nil
              - set(attributes["log.stream"], attributes["stream"]) where attributes["stream"] != nil
              - set(attributes["timestamp"], attributes["time"]) where attributes["time"] != nil

              # severity
              - set(severity_text, attributes["level"]) where attributes["level"] != nil
              - set(severity_text, "INFO") where severity_text == nil

              # cleanup pomocniczych pól
              - delete_key(attributes, "log_message") where attributes["log_message"] != nil
              - delete_key(attributes, "stream") where attributes["stream"] != nil
              - delete_key(attributes, "span_id") where attributes["span_id"] != nil

      batch: {}

    exporters:
      otlphttp/logs:
        endpoint: "http://{{ .Values.loki.name }}:{{ .Values.loki.port }}/otlp"
        tls:
          insecure: true

      debug/logs:
        verbosity: detailed

    service:
      telemetry:
        logs:
          level: debug
      pipelines:
        logs:
          receivers: [filelog]
          processors: [transform/enrich-logs, batch]
          exporters: [debug/logs, otlphttp/logs]
        # traces:
        #   receivers: [otlp]
        #   processors: [k8sattributes, batch]
        #   exporters: [otlp/jaeger]
        #
        # metrics:
        #   receivers: [otlp]
        #   processors: [k8sattributes, batch]
        #   exporters: [prometheusremotewrite]

---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: otel-collector
spec:
  selector:
    matchLabels:
      app: otel-collector
  template:
    metadata:
      labels:
        app: otel-collector
    spec:
      serviceAccountName: otel-collector
      containers:
        - name: otel-collector
          image: {{ .Values.otelCollector.image }}
          imagePullPolicy: {{ .Values.otelCollector.pullPolicy }}
          args: ["--config=/etc/otelcol/config.yaml"]
          ports:
            - name: otlp-grpc
              containerPort: 4317
            - name: otlp-http
              containerPort: 4318
          volumeMounts:
            - name: collector-config
              mountPath: /etc/otelcol
            - name: varlogcontainers
              mountPath: /var/log/containers
            - name: varlogpods
              mountPath: /var/log/pods
            - name: varlibdockercontainers
              mountPath: /var/lib/docker/containers
          resources: {}
      volumes:
        - name: collector-config
          configMap:
            name: otel-collector-config
        - name: varlogcontainers
          hostPath:
            path: /var/log/containers
            type: Directory
        - name: varlogpods
          hostPath:
            path: /var/log/pods
            type: Directory
        - name: varlibdockercontainers
          hostPath:
            path: /var/lib/docker/containers
            type: Directory
---
apiVersion: v1
kind: Service
metadata:
  name: otel-collector
spec:
  selector:
    app: otel-collector
  ports:
    - name: otlp-grpc
      port: 4317
      targetPort: 4317
    - name: otlp-http
      port: 4318
      targetPort: 4318
  type: ClusterIP